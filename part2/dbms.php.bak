<?php
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'PHPMailer/src/Exception.php';
require 'PHPMailer/src/PHPMailer.php';
require 'PHPMailer/src/SMTP.php';
@ $json =file_get_contents( "php://input" );
@ $data=json_decode($json,true);

$checkmail=true;

$username="huanbin";
$password="24361Zhb1152";
$connection_string="oracle.cise.ufl.edu:1521/orcl";
global $con;
$con=oci_connect($username,$password,$connection_string);


switch($data["action"])
{
    case "deleteit":deleteit();break;
    case "acceptit":acceptit();break;
    case "searchcommunity":searchcommunity();break;
    case "joincommunity":joincommunity();break;
    case "createcommunity":createcommunity();break;
    case "logincheck":logincheck(); break;
    case "registercheck":registercheck();break;
    case "searchdata":searchdata();break;
    case "getdataformat":getdataformat();break;
    case "deletedata":deletedata();break;
    case "checkrequest":checkrequest();break;
    case "changepassword":changepassword();break;
    case "forgetpassword":forgetpassword();break;
    case "adddataformat":adddataformat();break;
    case "deleteformat":deleteformat();break;
    case "sharedata":sharedata();break;
    case "searchchoose":searchchoose();break;
    case "deletesharing":deletesharing();break;
    default:break;
}

oci_close($con);


function changepassword(){
    global $data;
    global $con;
    $code=$data["code"];
    $password=$data["password"];
    $query="UPDATE USER_INFO SET password=:pw,changepw=0 WHERE (pcode=:code AND changepw=1)";
    $stmt = oci_parse($con, $query);
    oci_bind_by_name($stmt, ":pw",$password);
    oci_bind_by_name($stmt, ":code",$code);
    oci_execute($stmt);
    $stmt=oci_parse($con, 'commit');
    oci_execute($stmt);
    echo "success!";
}

function forgetpassword(){
    global $data;
    global $con;
    $email=$data["email"];
    $userid=$data["userid"];
   // echo $user;
    if ($userid!="" && $email!=""){
        $query="SELECT * FROM USER_INFO WHERE username=:id AND email=:email AND verified=1";
        $stmt = oci_parse($con, $query);
        oci_bind_by_name($stmt, ":id",$userid);
        oci_bind_by_name($stmt, ":email",$email);
        oci_execute($stmt);
        if(oci_fetch_all($stmt,$records)==0){
            echo 'userID does not match the email,it will be enough if your choose one of them!';
            return;
        }
    }
    else
    if ($userid!=""){
        $query="SELECT * FROM USER_INFO WHERE username=:id AND verified=1";
        $stmt = oci_parse($con, $query);
        oci_bind_by_name($stmt, ":id",$userid);
        oci_execute($stmt);
        if(oci_num_rows($stmt)==0){
            echo 'userID does not exist!';
            return;
        }
    }
    else{
    $query="SELECT * FROM USER_INFO WHERE email=:email AND verified=1";
    $stmt = oci_parse($con, $query);
    oci_bind_by_name($stmt, ":email",$email);
    oci_execute($stmt);
    if(oci_num_rows($stmt)==0){
        echo 'email does not exist!';
        return;
    }
    }
    $code=create_guid();
    $query="UPDATE USER_INFO SET changepw=1,pcode=:code WHERE (email=:email OR username=:id) AND verified=1";
    $stmt = oci_parse($con, $query);
    oci_bind_by_name($stmt, ":id",$userid);
    oci_bind_by_name($stmt, ":email",$email);
    oci_bind_by_name($stmt, ":code",$code);
    oci_execute($stmt);
    $stmt=oci_parse($con, 'commit');
    oci_execute($stmt);
    $message="Please verify the email and activate your account by click the link 10.227.162.163/medicalshare/part1/changepassword.php?code=".$code;
    sendmail($email,$message);
    echo "email has sent!";
}

function sendmail($email,$link){
    //  require 'PHPMailerAutoload.php';
    global $checkmail;
    $checkmail=true;
    $mail = new PHPMailer;
    //  $mail->SMTPDebug = 2;                               // Enable verbose debug output
    
    $mail->isSMTP();                                      // Set mailer to use SMTP
    $mail->Host = 'smtp.gmail.com;smtp.gmail.com';  // Specify main and backup SMTP servers.
    $mail->SMTPAuth = true;                               // Enable SMTP authentication
    $mail->Username = 'mcyworkmail@gmail.com';                 // SMTP username
    $mail->Password = 'efcggdyzbthacgqi';                           // SMTP password
    $mail->SMTPSecure = 'ssl';                            // Enable TLS encryption, `ssl` also accepted
    $mail->Port = 465;                                    // TCP port to connect to
    
    $mail->setFrom('mcyworkmail@gmail.com');
    $mail->addAddress($email);     // Add a recipient
    //  $mail->addAddress('ellen@example.com');               // Name is optional
    //  $mail->addReplyTo('info@example.com', 'Information');
    //  $mail->addCC('cc@example.com');
    //  $mail->addBCC('bcc@example.com');
    
    //  $mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
    //   $mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
    $mail->isHTML(true);                                  // Set email format to HTML
    
    $mail->Subject = "Second Car Website email verify link";
    $mail->Body    = $link;
    //  $mail->AltBody = 'This is the body in plain text for non-HTML mail clients';
    @  $mail->SMTPOptions = array(
        @      'ssl' => array(
            @          'verify_peer' => false,
            @          'verify_peer_name' => false,
            @          'allow_self_signed' => true
        )
    );
    if(!$mail->send()){
        echo "Mail Address Error!";
        $checkmail=false;
    }
}

function create_guid($namespace = null) {
    static $guid = '';
    $uid = uniqid ( "", true );
    
    $data = $namespace;
    $data .= $_SERVER ['REQUEST_TIME'];
    $data .= $_SERVER ['HTTP_USER_AGENT'];
    // $data .= $_SERVER ['SERVER_ADDR'];
    //  $data .= $_SERVER ['SERVER_PORT'];
    $data .= $_SERVER ['REMOTE_ADDR'];
    $data .= $_SERVER ['REMOTE_PORT'];
    
    $hash = strtoupper ( hash ( 'ripemd128', $uid . $guid . md5 ( $data ) ) );
    $guid = substr ( $hash, 0, 8 ) . '-' . substr ( $hash, 8, 4 ) . '-' . substr ( $hash, 12, 4 ) . '-' . substr ( $hash, 16, 4 ) . '-' . substr ( $hash, 20, 12 );
    
    return $guid;
}

function logincheck()
{
    global $data;
    global $con;
    $userID=$data["userid"];
    $password=$data['password'];
    $stmt = oci_parse($con, 'SELECT * FROM USER_INFO WHERE username=:id and password=:pw and verified=1');
    oci_bind_by_name($stmt, ":id",$userID);
    oci_bind_by_name($stmt, ":pw",$password);
    oci_execute($stmt);
    $records=array();
    if(oci_fetch_all($stmt, $record)==1){
        while($r = oci_fetch_array($stmt,OCI_ASSOC))
        {
            $records[] = $r;
        }
        session_start();
        $json_data=json_encode($records);
        $_SESSION['userID']="";
        $_SESSION['password']="";
        $_SESSION['json_data']=$json_data;
        oci_free_statement($stmt);
        echo "success!";
    }
    else
    {
        echo "Please input correct userID and password or verify your account!";
    }
    return;
}

function registercheck() {
    global $data;
    global $con;
    $userID=$data["userid"];
    $password=$data['password'];
    $email=$data['email'];
    $contact=$data['contact'];
    
    $query="SELECT * FROM USER_INFO WHERE username=:id";
    $stmt = oci_parse($con, $query);
    oci_bind_by_name($stmt, ":id",$userID);
    oci_execute($stmt);
    if( oci_num_rows($stmt)!=0){
        echo 'Existed userID. Please Try another!';
        return;
    }
   // echo $email;
    
    $query="SELECT * FROM USER_INFO WHERE EMAIL=:email AND verified=0";
    $stmt = oci_parse($con, $query);
    oci_bind_by_name($stmt, ":email",$email);
    oci_execute($stmt);
    if(oci_num_rows($stmt)!=0){
        echo 'Email already used. Please Try another!';
        return;
    }
    $code=create_guid();
    $message="Please verify the email and activate your account by click the link 10.227.162.163/SecondCarWeb/part1/verified.php?code=".$code;
    sendmail($email,$message);
    global $checkmail;
    if(!$checkmail){
        reutrn;
    }
    $query="INSERT INTO USER_INFO VALUES ((SELECT MAX(USERID)+1 FROM USER_INFO),:email,:id,:pw,:contact,null,null,null,0,:code,0,'')";
    $stmt = oci_parse($con, $query);
    oci_bind_by_name($stmt, ":code",$code);
    oci_bind_by_name($stmt, ":pw",$password);
    oci_bind_by_name($stmt, ":contact",$contact);
    oci_bind_by_name($stmt, ":id",$userID);
    oci_bind_by_name($stmt, ":email",$email);
    oci_execute($stmt);
    // $subject="Medical Data Sharing System email verify link";
    $stmt=oci_parse($con, 'commit');
    oci_execute($stmt);
    //  echo $code;
    
    echo "success!";
}


?>